/*
 * Copyright (c) 2020 The ZMK Contributors
 *
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>

// layers
#define ALPHA    0
#define NUMBERS  1
#define CODING   2
#define CONTROLS 3

// special characters
#define CURR_YEN     LA(Y)
#define CURR_EURO    LA(LS(N2))
#define CURR_POUND   LA(N3)

// thumb key positions
#define L3 32
#define L2 33
#define L1 34
#define R1 35
#define R2 36
#define R3 37

// combo helper
#define COMBO(NAME, KEYPOS, BINDINGS) \
  combo_##NAME { \
    timeout-ms = <100>; \
    key-positions = <KEYPOS>; \
    bindings = <BINDINGS>; \
  };

// macro helper
#define MACRO(NAME, BINDINGS) \
  macro_##NAME: macro_##NAME { \
    compatible = "zmk,behavior-macro"; \
    label = "##NAME"; \
    #binding-cells = <0>; \
    wait-ms = <40>; \
    tap-ms = <40>; \
    bindings = <BINDINGS>; \
  };

&sl {
    release-after-ms = <2000>;
};

&sk {
    release-after-ms = <2000>;
    quick-release;
    // ignore-modifiers;
};

&caps_word {
    continue-list = <UNDERSCORE MINUS>;
};

/ {
  chosen {
    zmk,matrix_transform = &five_column_transform;
  };

  conditional_layers {
    compatible = "zmk,conditional-layers";
      tri_layer {
        if-layers = <1 2>;
        then-layer = <3>;
      };
  };

  combos {
    compatible = "zmk,combos";

    /// horizontal, adjacent

    COMBO(  qw,         0 1,    &kp LGUI(W)                          )
    // COMBO(  we,         1 2,    &kp                                  )
    // COMBO(  er,         2 3,    &kp                                  )
    COMBO(  rt,         3 4,    &kp UNDERSCORE                       )

    COMBO(  yu,         5 6,    &kp MINUS                            )
    // COMBO(  ui,         6 7,    &kp                                  )
    // COMBO(  io,         7 8,    &kp                                  )
    // COMBO(  op,         8 9,    &kp                                  )

    // COMBO(  as,         10 11,  &kp                                  )
    COMBO(  sd,         11 12,  &kp BACKSPACE                        )
    COMBO(  df,         12 13,  &kp SPACE                            )
    COMBO(  fg,         13 14,  &kp DELETE                           )

    COMBO(  hj,         15 16,  &kp BACKSPACE                        )
    COMBO(  jk,         16 17,  &kp ESCAPE                           )
    COMBO(  kl,         17 18,  &kp DELETE                           )
    COMBO(  lscln,      18 19,  &kp APOSTROPHE                       )

    COMBO(  zx,         20 21,  &kp LG(K)                            )
    COMBO(  xc,         21 22,  &kp LG(X)                            )
    COMBO(  cv,         22 23,  &kp LG(C)                            )
    COMBO(  vb,         23 24,  &kp LG(V)                            )

    // COMBO(  nm,         25 26,  &kp                                  )
    // COMBO(  mcomma,     26 27,  &kp                                  )
    // COMBO(  commdot,    27 28,  &kp                                  )
    // COMBO(  dotslsh,    28 29,  &kp                                  )

    /// vertical, adjacent

    COMBO(  qa,         0 10,   &kp EXCL                             )
    COMBO(  ws,         1 11,   &kp AT                               )
    COMBO(  ed,         2 12,   &kp HASH                             )
    COMBO(  rf,         3 13,   &kp DOLLAR                           )
    COMBO(  tg,         4 14,   &kp PERCENT                          )

    COMBO(  yh,         5 15,   &kp CARET                            )
    COMBO(  uj,         6 16,   &kp AMPS                             )
    COMBO(  ik,         7 17,   &kp STAR                             )
    COMBO(  ol,         8 18,   &kp GRAVE                            )
    COMBO(  pscln,      9 19,   &kp EQUAL                            )

    COMBO(  az,         0 10,   &kp BSLH                             )
    COMBO(  sx,         1 11,   &kp LT                               )
    COMBO(  dc,         2 12,   &kp LBRC                             )
    COMBO(  fv,         3 13,   &kp LBKT                             )
    COMBO(  gb,         4 14,   &kp LPAR                             )

    COMBO(  hn,         5 15,   &kp RPAR                             )
    COMBO(  jm,         6 16,   &kp RBKT                             )
    COMBO(  kcomm,      7 17,   &kp RBRC                             )
    COMBO(  ldot,       8 18,   &kp GT                               )
    COMBO(  sclnslsh,   9 19,   &kp EXCL                             )

    /// one-handed one-shots, mirrored on both sides

    COMBO(  l2_q,       L2 0,   &kp LG(LC(Q))                        )

    COMBO(  l2_w,       L2 1,   &sl NUMBERS                          )
    COMBO(  l2_e,       L2 2,   &sl CODING                           )
    COMBO(  l2_r,       L2 3,   &sl CONTROLS                         )
    COMBO(  l2_t,       L2 4,   &caps_word                           )
    COMBO(  l2_a,       L2 10,  &sk LCTRL                            )
    COMBO(  l2_s,       L2 11,  &sk LALT                             )
    COMBO(  l2_d,       L2 12,  &sk LGUI                             )
    COMBO(  l2_f,       L2 13,  &sk LSHIFT                           )
    COMBO(  l2_g,       L2 14,  &sk LC(LA(LG(LSHIFT)))               ) // hyper
    COMBO(  l2_z,       L2 20,  &kp CAPS                             )
    COMBO(  l2_x,       L2 21,  &tog NUMBERS                         )
    COMBO(  l2_c,       L2 22,  &tog CODING                          )
    COMBO(  l2_v,       L2 23,  &tog CONTROLS                        )
    COMBO(  l2_b,       L2 24,  &sk LC(LA(LSHIFT))                   ) // meh

    COMBO(  r2_y,       R2 0,   &caps_word                           )
    COMBO(  r2_u,       R2 1,   &sl CONTROLS                         )
    COMBO(  r2_i,       R2 2,   &sl CODING                           )
    COMBO(  r2_o,       R2 3,   &sl NUMBERS                          )
    COMBO(  r2_p,       R2 4,   &to ALPHA                            ) // back to default layer
    COMBO(  r2_h,       R2 10,  &sk RC(RA(RG(RSHIFT)))               ) // hyper
    COMBO(  r2_j,       R2 11,  &sk RSHIFT                           )
    COMBO(  r2_k,       R2 12,  &sk RGUI                             )
    COMBO(  r2_l,       R2 13,  &sk RALT                             )
    COMBO(  r2_scln,    R2 14,  &sk RCTRL                            )
    COMBO(  r2_n,       R2 20,  &sk LC(LA(LSHIFT))                   )
    COMBO(  r2_m,       R2 21,  &tog CONTROLS                        )
    COMBO(  r2_comm,    R2 22,  &tog CODING                          )
    COMBO(  r2_dot,     R2 23,  &tog NUMBERS                         )
    COMBO(  r2_slsh,    R2 24,  &kp CAPS                             )

    /// two-handed symmetric combos

    // COMBO(  qp,         0 9,    &kp                                  )
    // COMBO(  wo,         1 8,    &kp                                  )
    // COMBO(  ei,         2 7,    &kp                                  )
    // COMBO(  ro,         3 6,    &kp                                  )
    // COMBO(  ty,         4 5,    &kp                                  )

    COMBO(  ascln,      10 19,  &sk LCTRL                            )
    COMBO(  sl,         11 18,  &sk LALT                             )
    COMBO(  dk,         12 17,  &sk LGUI                             )
    COMBO(  fj,         13 16,  &sk LSHIFT                           )
    COMBO(  gh,         14 15,  &sk LC(LA(LG(LSHIFT)))               ) // hyper

    COMBO(  zslsh,      20 29,  &kp LGUI(Z)                          )
    COMBO(  xdot,       21 28,  &kp LGUI(X)                          )
    COMBO(  ccomm,      22 27,  &kp LGUI(C)                          )
    COMBO(  vm,         23 26,  &kp LGUI(V)                          )
    COMBO(  bn,         24 25,  &sk LC(LA(LSHIFT))                   ) // meh

    COMBO(  LT1RT1,     L1 R1,  &kp CAPS                             )
    COMBO(  LT2RT2,     L2 R2,  &caps_word                           )
    COMBO(  LT3RT3,     L3 R3,  &tog CONTROLS                        )

    /// other combos
    COMBO(  ddot,       12 28,  &macro_is_unread                     ) // types "is:unread" I use frequently in Gmail search
  };

  macros {
    MACRO(  is_unread,          &macro_tap &kp I &kp S &kp COLON &kp U &kp N &kp R &kp E &kp A &kp D)
  };

  keymap {
    compatible = "zmk,keymap";

    default_layer {
      label = "alpha";

      /*
        Q              W              E              R              T                   Y              U              I              O              P
        A              S              D              F              G                   H              J              K              L              ;
        Z              X              C              V              B                   N              M              ,              .              /
                                      NUMBERS        Shift (One)    Tab                 Enter          Space          CODING
      */
      bindings = <
        &kp Q          &kp W          &kp E          &kp R          &kp T               &kp Y          &kp U          &kp I          &kp O          &kp P
        &kp A          &kp S          &kp D          &kp F          &kp G               &kp H          &kp J          &kp K          &kp L          &kp SEMI
        &kp Z          &kp X          &kp C          &kp V          &kp B               &kp N          &kp M          &kp COMMA      &kp DOT        &kp FSLH
                                      &tog NUMBERS   &sk LSHFT      &kp TAB             &kp RETURN     &kp SPACE      &tog CODING
      >;
    };

    numbers {
      label = "numbers";

      /*
        F1             F2             F3             F4             F5                  F6             F7             F8             F9             F10
        1              2              3              4              5                   6              7              8              9              10
        ¥              €              -              =              *                   £              $              ,              .              /
                                      _____          _____          _____               _____          _____          _____
      */
      bindings = <
        &kp F1         &kp F2         &kp F3         &kp F4         &kp F5              &kp F6         &kp F7         &kp F8         &kp F9         &kp F10
        &kp N1         &kp N2         &kp N3         &kp N4         &kp N5              &kp N6         &kp N7         &kp N8         &kp N9         &kp N0
        &kp CURR_YEN   &kp CURR_EURO  &kp MINUS      &kp EQUAL      &kp STAR            &kp CURR_POUND &kp DOLLAR     &kp COMMA      &kp DOT        &kp FSLH
                                      &trans         &trans         &trans              &trans         &trans         &trans
      >;
    };

    coding {
      label = "coding";

      /*
        ^              @              (              )              $                   Home           PgDn           PgUp           End            |
        '              `              [              ]              *                   Left           Down           Up             Right          \
        !              #              -              =              ~                   %              &              ,              .              /
                                      _____          _____          _____               _____          _____          _____
      */
      bindings = <
        &kp CARET      &kp AT         &kp LPAR       &kp RPAR       &kp DOLLAR          &kp HOME       &kp PG_DN      &kp PG_UP      &kp END        &kp PIPE
        &kp APOS       &kp GRAVE      &kp LBKT       &kp RBKT       &kp STAR            &kp LEFT       &kp DOWN       &kp UP         &kp RIGHT      &kp BSLH
        &kp EXCL       &kp HASH       &kp MINUS      &kp EQUAL      &kp TILDE           &kp PERCENT    &kp AMPS       &kp COMMA      &kp DOT        &kp FSLH
                                      &trans         &trans         &trans              &trans         &trans         &trans
      >;
    };

    controls {
      label = "controls";

      /*
        Ctx Menu       Prev           Play/Pause     Next           Vol Up              F7             F8             F9             F10            F13
        BT Clr         BT 1           BT 2           BT 3           Vol Dn              F4             F5             F6             F11            F14
        _____          _____          _____          _____          _____               F1             F2             F3             F12            F15
                                      _____          _____          _____               _____          _____          _____
      */
      bindings = <
        &kp K_CMENU    &kp C_PREV     &kp C_PP       &kp C_NEXT     &kp C_VOL_UP        &kp F7         &kp F8         &kp F9         &kp F10        &kp F13
        &bt BT_CLR     &bt BT_SEL 0   &bt BT_SEL 1   &bt BT_SEL 2   &kp C_VOL_DN        &kp F4         &kp F5         &kp F6         &kp F11        &kp F14
        &none          &none          &none          &none          &none               &kp F1         &kp F2         &kp F3         &kp F12        &kp F15
                                      &trans         &trans         &trans              &trans         &trans         &trans
      >;
    };
  };
};
